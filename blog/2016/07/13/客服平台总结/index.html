<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 客服平台总结 · LUOYE</title><meta name="description" content="客服平台总结 - Luoye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="https://s10.mogucdn.com/mlcdn/c45406/181108_569k3hlic06fcbj3i96b426i024d9.ico"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="stylesheet" href="/blog/css/prism.css"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="https://s10.mogucdn.com/mlcdn/c45406/180104_87747584h81ji8hjc144bkgkgk9ai_460x460.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="https://luoyefe.com" target="_blank" class="nav-list-link">INDEX</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/luo-ye-42-22" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="https://github.com/luoye-fe" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">客服平台总结</h1><div class="post-info">2016年7月13日</div><div class="post-content"><h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><p>Vue是一个构建数据驱动的 web 界面的库，也就是一个以 MVVM 为核心的库。  </p>
<h4 id="为什么选择Vue"><a href="#为什么选择Vue" class="headerlink" title="为什么选择Vue"></a>为什么选择Vue</h4><ul>
<li><p>简洁</p>
<p>  API 足够简洁明了，文档足够清晰有条理，上手难度足够低</p>
<p>  HTML 模板加上 JSON 数据，就是一个 Vue 实例。    </p>
</li>
<li><p>数据驱动</p>
<p>  DOM和数据绑定，对数据的操作自动追踪依赖的模板表达式，自动更新DOM。  </p>
<p>  例如，列表的渲染，只需给定一个数组，将这个数组绑定到列表的模板表达式上，数组的变化自动触发DOM的更新，无需手动维护DOM。  </p>
</li>
<li><p>组件化</p>
<p>  提供了一套完整的组件化开发方式，用解藕、可敷用的组件来构造界面，极大简化代码量的同时，对维护工作也相当友好。  </p>
<p>  例如，全局的 loading/alert/表单 组件、局部的表格组件，一处定义，多处复用，一处更改，全局同步。  </p>
</li>
<li><p>快速</p>
<p>  库内部对自动更新DOM的操作做了很多优化，内部ID排序，最小变更步骤等，和手动更新DOM相比，速度更快。  </p>
</li>
<li><p>轻量但不失强大</p>
<p>  Vue 本身只是一个关注 view 层的轻量化库，但是搭配官方出品的几个轻量库，能够完成相当复杂的 web 应用。  </p>
<p>  例如，客服平台中用到的 vue-router ，用来控制路由；vuex，用来集中式管理应用状态，控制 SPA 内数据流向。  </p>
</li>
<li><p>新技术的试验田</p>
<p>  Vue 足够灵活，能够完美的搭配前端中新兴的各种技术，加快开发效率，规范开发流程，减少人工操纵。  </p>
<p>  例如，客服平台中模块化的 js 开发方式，webpack 编译，NPM 管理依赖，sass 书写样式等，都能够融合进 vue 的开发体系中。  </p>
</li>
</ul>
<h4 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h4><ul>
<li><p><a href="http://cn.vuejs.org/" target="_blank" rel="external">Vue 文档</a></p>
</li>
<li><p><a href="http://router.vuejs.org/zh-cn/index.html" target="_blank" rel="external">Vue-router 文档</a></p>
</li>
<li><p><a href="http://vuex.vuejs.org/zh-cn/intro.html" target="_blank" rel="external">Vuex 文档</a></p>
</li>
</ul>
<h2 id="NodeJs-Npm"><a href="#NodeJs-Npm" class="headerlink" title="NodeJs/Npm"></a>NodeJs/Npm</h2><h4 id="NodeJs"><a href="#NodeJs" class="headerlink" title="NodeJs"></a>NodeJs</h4><p>NodeJs 虽然是一门后端语言，但是在前端工作中，利用 NodeJs 开发的一些工具能够极大简化我们的工作。  </p>
<p>例如，客服平台实现了一个简易的 web server，本地开发时以这个 web server 作为入口，可以很方便的访问接口，代理静态资源等。  </p>
<p>利用 NodeJs 开发的工具也能够完成自动化操作、构建等任务，这个将在下文的 webpack/gulp 部分具体讲述。</p>
<h4 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h4><p>NPM 是管理 NodeJs 开发依赖的工具，同样能够用在前端的开发工作中，大部分的开发依赖通过 NPM 来管理，杜绝手工管理依赖包，也能够很方便的控制依赖的版本。  </p>
<p>NPM 还提供一些便捷的 script 定义方式，在一个 NPM 项目下，会存在一个 <code>package.json</code> 文件，其中有一个字段为 <code>scripts</code> ，在这个字段中定义的 key ，可以通过 <code>npm run {key}</code> 来执行 value 中的命令。  </p>
<p>例如，在本地开发时，需要连接后台人员的机器，可以执行 <code>npm run localtest</code> 命令，而实际执行的命令是 <code>scripts</code> 字段中 <code>localtest</code> 对应的 <code>NODE_ENV=localtest gulp watch</code> 命令。  </p>
<p>这相当于为某些命令做了个缩写，但是在本项目中，由于环境变量定义方式不同，mac 环境可以直接执行 <code>npm run localtest</code> ，win 上只能执行具体的命令 <code>NODE_ENV=localtest gulp watch</code>。  </p>
<h4 id="相关文档-1"><a href="#相关文档-1" class="headerlink" title="相关文档"></a>相关文档</h4><ul>
<li><p><a href="http://nodejs.cn/api/" target="_blank" rel="external">NodeJs 文档</a></p>
</li>
<li><p><a href="https://docs.npmjs.com/" target="_blank" rel="external">NPM 文档</a></p>
</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>客服平台对 NodeJs 的依赖不可或缺，开发人员必须安装 NodeJs ，建议版本 v4.2.4</p>
<h2 id="ES6-7"><a href="#ES6-7" class="headerlink" title="ES6/7"></a>ES6/7</h2><p>JavaScript 这门语言在以往的版本中存在着很多缺陷，比如没有类，没有标准的模块管理，没有统一的异步流程控制API，没有块级作用域赋值等等，但是在新版本中，这些都有了相应的解决方案，所以客服平台的开发，我们选择了 JS 的新标准 ES6 作为主要开发语言。  </p>
<p>本项目中用到的主要 ES6 新特性包括：  </p>
<ul>
<li>变量声明：let/const 命令</li>
<li>变量的结构赋值</li>
<li>模板字符串</li>
<li>箭头函数</li>
<li>模块管理：import/export</li>
<li>Promise 对象控制异步流程</li>
<li>其他的新API</li>
</ul>
<p><a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ES6 文档</a></p>
<h2 id="Webpack-Gulp"><a href="#Webpack-Gulp" class="headerlink" title="Webpack/Gulp"></a>Webpack/Gulp</h2><h4 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h4><p>上文提到，我们用了 Vue，用了 ES6，用了很多新特性新东西，但是对于浏览器来说，这些东西浏览器是没有办法直接运行的，所以需要有构建这一过程，我们选择了 webpack 这个工具。  </p>
<p>webpack 是一个灵活的模块打包工具，搭配不同的 plugin 和 loader 可以打包几乎所有 js 方言，css 方言，不同的模板文件，最后生成可供浏览器直接运行的 js 文件。  </p>
<p>客服平台的 webpack 配置在 <code>gulpfile.js</code> 文件的 <code>webpackConfig</code> 变量中，具体可以看代码。  </p>
<p><a href="http://webpack.github.io/docs/" target="_blank" rel="external">webpack 文档</a></p>
<h4 id="Gulp"><a href="#Gulp" class="headerlink" title="Gulp"></a>Gulp</h4><p>除了 webpack 用来打包构建之外，还有一些额外的自动化工作需要完成，比如图片的拷贝，静态资源更改 hash 值以控制缓存，打包四个环境不同的 bundle 包等，这一部分我们选择了 gulp 来完成。  </p>
<p>gulp 主要利用 NodeJs 文件流的概念在内存中操作文件，减少 IO 操作，能够更加快速的完成复杂的构建工作。  </p>
<p><a href="http://www.gulpjs.com.cn/docs/" target="_blank" rel="external">gulp 文档</a></p>
<h2 id="Sass-Jade"><a href="#Sass-Jade" class="headerlink" title="Sass/Jade"></a>Sass/Jade</h2><h4 id="Sass"><a href="#Sass" class="headerlink" title="Sass"></a>Sass</h4><p>一个 css 方言，提供了嵌套的书写方式，css 的变量定义，逻辑控制功能等。  </p>
<p>客服平台使用的是页面构建组提供的 sass 源码，最后使用 gulp 编译成浏览器可识别的 css。  </p>
<p><a href="http://sass.bootcss.com/docs/sass-reference/" target="_blank" rel="external">sass 文档</a></p>
<h4 id="Jade-Pug"><a href="#Jade-Pug" class="headerlink" title="Jade(Pug)"></a>Jade(Pug)</h4><p>HTML 模板引擎，页面构建组使用的 HTML 方言，用更加简洁的方式书写 HTML，也可以在 HTML 中加以逻辑，写出更加强大健壮的 HTML 模板。  </p>
<p>客服平台使用的是页面构建组提供的生成后的普通 HTML 文件。  </p>
<p>已更名为 Pug 。  </p>
<p><a href="http://jade-lang.com/" target="_blank" rel="external">pug 文档</a></p>
<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>客服平台的所有代码，都托管在公司的 gitlab 上，项目地址是： <code>http://gitlab.intra.gomeplus.com/gomeplusFED/CSP</code>。  </p>
<p>配合 git ，我们完成了一套完整的开发发布流程。  </p>
<h2 id="Webscoket"><a href="#Webscoket" class="headerlink" title="Webscoket"></a>Webscoket</h2><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>WebSocket协议，代替原先http协议的1s轮询，能更好的节省服务器资源和带宽并达到实时通讯，本项目用于客服与买家的实时通讯聊天、表情、上传图片、接收图片音频视频。   </p>
<pre><code>```js
// 创建一个Socket实例
var socket = new WebSocket(&#39;ws://localhost:8080&#39;); 

// 打开Socket 
socket.onopen = function(event) { 

    // 发送一个初始化消息
    socket.send(&#39;I am the client and I\&#39;m listening!&#39;); 

    // 监听消息
    socket.onmessage = function(event) { 
        console.log(&#39;Client received a message&#39;,event); 
    }; 

    // 监听Socket的关闭
    socket.onclose = function(event) { 
        console.log(&#39;Client notified socket has closed&#39;,event); 
    };    

    // 监听Socket报错
    socket.onerror = function(event) { 
        console.log(&#39;Client notified socket has error&#39;,event); 
    }; 

    // 关闭Socket.... 
    //socket.close() 
};
```
</code></pre><h4 id="断开重连机制"><a href="#断开重连机制" class="headerlink" title="断开重连机制"></a>断开重连机制</h4><ul>
<li><p>断网重连</p>
</li>
<li><p>关闭重连</p>
</li>
<li><p>异常重连</p>
</li>
<li><p>客服选择在线重连    </p>
</li>
</ul>
<p><a href="https://msdn.microsoft.com/library/hh673567.aspx" target="_blank" rel="external">Webscoket 文档</a></p>
<h2 id="业务详解"><a href="#业务详解" class="headerlink" title="业务详解"></a>业务详解</h2><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><pre><code>```shell
├── src                             源码文件夹
│   ├── font                            font 文件夹
│   ├── img                             img 文件夹
│   ├── css                             css 文件夹
│   │   ├── app.scss                        样式主入口
│   │   ├── common                          基础样式文件夹
│   │   ├── module                          业务样式文件夹
│   │   │   └── all.scss                        所有业务样式
│   │   └── vendors                         第三方插件样式
│   └── js                              js 文件夹
│       ├── app.js                          app 入口文件 （定义路由表，启动项目，过滤ajax请求等）
│       ├── debug.js                        debug 文件 （定义一些全局变量，在控制台直接调用）
│       ├── base                            基础功能文件夹
│       ├── component                       组件文件夹
│       │   ├── app.vue                         入口组件 （组织全局组件，定义路由容器）
│       │   ├── base                            全局组件 （alert、loading组件等）
│       │   ├── common                          通用组件 （导航、时间选择器、头部、尾部等）
│       │   ├── dashboard                       dashboard 路由下所有组件
│       │   │   ├── account-manage.vue              账户管理
│       │   │   ├── chat-record.vue                 聊天记录
│       │   │   ├── common-msg.vue                  常用语
│       │   │   ├── config.vue                      配置管理
│       │   │   ├── index.vue                       首页
│       │   │   └── password.vue                    修改密码
│       │   ├── form                            通用表单组件
│       │   ├── im                              im 路由下所有组件
│       │   │   ├── common_msg.vue                  常用语
│       │   │   ├── contacts.vue                    联系人
│       │   │   ├── header.vue                      头部 
│       │   │   ├── index.vue                       首页
│       │   │   └── record.vue                      聊天记录
│       │   └── login                           登陆组件
│       ├── config                              配置文件
│       │   ├── env                                 环境设置
│       │   └── http.json                           AJAX 请求跟路径配置文件
│       ├── directive                           指令文件夹
│       ├── filter                              过滤器文件夹
│       ├── store                               vuex 文件夹
│       ├── util                                工具函数文件夹
│       └── vendors                             第三方插件文件夹
├── dist                            编译打包生成的dist文件
├── app.babel.js                    node 执行文件入口 （babel引导）
├── app.js                          web server 入口文件
├── gulpfile.js                     gulp 配置文件
├── index.html                      view 首页
├── node_modules                    依赖文件夹 （npm install 后会出现）
├── package.json                    依赖管理配置文件
├── config.json                     项目配置文件
├── README.md                       README
├── .babelrc                        babel 配置文件
├── .bin                            脚本文件夹 （格式化文件脚本）
├── .gitignore                      git 忽略规则
├── doc                             文档文件夹
├── demo                            demo 
├── ui                              页面构建组提供的 ui 文件夹
├── development                     开发环境编译打包后产出目录
├── test                            测试环境编译打包后产出目录
├── pre-production                  预生产环境编译打包后产出目录
└── production                      生产环境编译打包后产出目录
```
</code></pre><h4 id="业务结构划分"><a href="#业务结构划分" class="headerlink" title="业务结构划分"></a>业务结构划分</h4><ul>
<li><p>登录<br>  <code>/src/js/component/login/index.vue</code><br>  <code>/#!/login</code></p>
</li>
<li><p>欢迎页<br>  <code>/src/js/component/dashboard/index.vue</code><br>  <code>/#!/dashboard</code></p>
</li>
<li><p>用户管理<br>  <code>/src/js/component/dashboard/account-manage.vue</code><br>  <code>/#!/dashboard/account-manage</code></p>
</li>
<li><p>聊天记录查询<br>  <code>/src/js/component/dashboard/chat-record.vue</code><br>  <code>/#!/dashboard/chat-record</code></p>
</li>
<li><p>常用语<br>  <code>/src/js/component/dashboard/common-msg.vue</code><br>  <code>/#!/dashboard/common-msg</code></p>
</li>
<li><p>系统配置管理<br>  <code>/src/js/component/dashboard/config.vue</code><br>  <code>/#!/dashboard/config</code></p>
</li>
<li><p>修改密码<br>  <code>/src/js/component/dashboard/password.vue</code><br>  <code>/#!/dashboard/password</code></p>
</li>
<li><p>IM<br>  <code>/src/js/component/im/index.vue</code><br>  <code>/#!/im</code> </p>
</li>
</ul>
<h2 id="发布流程"><a href="#发布流程" class="headerlink" title="发布流程"></a>发布流程</h2><ul>
<li><p><code>git checkout dev</code> 切换到dev更新到最新版本</p>
</li>
<li><p><code>git checkout pre-release</code> 切换到pre-release分支</p>
</li>
<li><p><code>git merge dev</code> merge dev分支到pre-release分支</p>
</li>
<li><p><code>git checkout release</code> 切换到release 分支</p>
</li>
<li><p><code>git checkout pre-release ./src index.html package.json gulpfile.js</code> 将 <code>./src index.html package.json gulpfile.js</code> 等指定文件merge过来</p>
</li>
<li><p><code>npm run buildall</code>  生成开发、测试、预生产、生产四个环境的待发布包裹</p>
</li>
<li><p><code>git commit -am &quot;提交信息&quot;</code>  提交所有变动</p>
</li>
<li><p><code>git push origin release --force</code>  覆盖式推送到远程release分支</p>
</li>
<li><p>通知BS发布对应环境的包裹</p>
</li>
</ul>
<h2 id="本地调试"><a href="#本地调试" class="headerlink" title="本地调试"></a>本地调试</h2><ul>
<li><p><code>git clone http://gitlab.intra.gomeplus.com/gomeplusFED/CSP.git</code></p>
</li>
<li><p><code>cd CSP</code></p>
</li>
<li><p><code>npm install -d</code></p>
</li>
<li><p><code>npm run localdev</code> 本地开发，连接AMP平台</p>
</li>
<li><p><code>npm run localtest</code> 本地开发，连接后台人员本机</p>
</li>
<li><p><code>node app.babel.js</code> 开启本地静态资源服务</p>
</li>
<li><p><code>ifconfig(mac)\ipconfig(win)</code> 查看ip</p>
</li>
<li><p><code>http://</code> +  ip  +  <code>:1234/#!/login</code> 访问地址</p>
</li>
<li><p>可以通过修改 <code>/src/js/config/http.json</code> 文件改变各个环境地址   </p>
</li>
<li><p><code>http.json</code> 文件</p>
<pre><code class="line-numbers language-json">  {
      &quot;localdev&quot;: &quot;http://10.69.205.26:9090/mock/5742c66eb094235129ee29b5&quot;,
      &quot;localtest&quot;: &quot;http://10.125.2.43:6080/venus-crm-rest&quot;,
      &quot;development&quot;:&quot;http://10.69.201.13:8080/venus-crm-rest&quot;,
      &quot;test&quot;: &quot;http://10.125.2.43:6080/venus-crm-rest&quot;,
      &quot;pre-production&quot;: &quot;http://10.125.2.10:8093/venus-crm-rest/&quot;,
      &quot;production&quot;: &quot;http://10.125.139.206:8093/venus-crm-rest&quot;
  }
</code></pre>
</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/blog/2016/07/21/git相关/" class="prev">上一篇</a><a href="/blog/2016/06/23/我的sublime配置/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'luoyefe';
var disqus_identifier = '2016/07/13/客服平台总结/';
var disqus_title = '客服平台总结';
var disqus_url = 'https://luoyefe.com/blog/2016/07/13/客服平台总结/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//luoyefe.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2023 <a href="https://luoyefe.com/blog">Luoye</a>, unless otherwise noted.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78104533-1",'auto');ga('send','pageview');
var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?213cc17b8240ff47d16b1b3aa9dbe0ad";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="/blog/js/prism.js"></script></body></html>