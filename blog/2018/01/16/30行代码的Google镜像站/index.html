<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 30行代码的Google镜像站 · LUOYE</title><meta name="description" content="30行代码的Google镜像站 - Luoye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/blog/favicon.ico"><link rel="stylesheet" href="/blog/css/apollo.css"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="https://s10.mogucdn.com/mlcdn/c45406/180104_87747584h81ji8hjc144bkgkgk9ai_460x460.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="https://luoyefe.com/blog" target="_blank" class="nav-list-link">INDEX</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/luo-ye-42-22" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="https://github.com/luoye-fe" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">30行代码的Google镜像站</h1><div class="post-info">2018年1月16日</div><div class="post-content"><h4 id="DEMO-SO-FREEDOM"><a href="#DEMO-SO-FREEDOM" class="headerlink" title="DEMO: SO FREEDOM"></a><strong>DEMO: <a href="http://so.luoyefe.com/" target="_blank" rel="external">SO FREEDOM</a></strong></h4><h4 id="源码地址-https-github-com-luoye-fe-so"><a href="#源码地址-https-github-com-luoye-fe-so" class="headerlink" title="源码地址: https://github.com/luoye-fe/so/"></a><strong>源码地址: <a href="https://github.com/luoye-fe/so/" target="_blank" rel="external">https://github.com/luoye-fe/so/</a></strong></h4><p>又是一个充满噱头的标题 = =。</p>
<p>思路是在研究 <code>NodeJS</code> 代理时想到的小 trick，说是 30 行，其实最重要的只有一行，即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.pipe(request(URL)).res;</span><br></pre></td></tr></table></figure>
<p>将客户端来的请求直接转发到相应的 URL 上，实现代理，基于这个原理，可以很容易的实现各种网站的镜像站点。</p>
<p>服务端代码加注释如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> URL = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">9901</span>;</span><br><span class="line"><span class="keyword">const</span> homeHTML = fs.readFileSync(<span class="string">'./home.html'</span>, <span class="string">'utf-8'</span>); <span class="comment">// 自定义的首页内容</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestInstance</span>(<span class="params">url, ua</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> request(&#123;</span><br><span class="line">		url,</span><br><span class="line">		headers: &#123; <span class="string">'User-Agent'</span>: ua &#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> url = URL.parse(req.url, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (url.pathname === <span class="string">'/'</span>) &#123;</span><br><span class="line">		<span class="comment">// 自定义首页</span></span><br><span class="line">		res.writeHeader(<span class="string">'200'</span>, &#123; <span class="string">'Contetn-Type'</span>: <span class="string">'text/html'</span> &#125;);</span><br><span class="line">		fs.createReadStream(<span class="string">'./home.html'</span>).pipe(res);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.pathname === <span class="string">'/bg'</span>) &#123;</span><br><span class="line">		<span class="comment">// 每日必应壁纸加速（给首页用，具体可看源码内逻辑）</span></span><br><span class="line">		req.pipe(requestInstance(<span class="string">`https://bing.ioliu.cn/v1?<span class="subst">$&#123;url.search&#125;</span>`</span>, req.headers[<span class="string">'user-agent'</span>])).pipe(res);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 这个就是最重要的一步了，将客户端来的请求，按照规则直接代理到 `google.com` 下</span></span><br><span class="line">		<span class="comment">// 这样客户端拿到的内容也是谷歌返回的内容了</span></span><br><span class="line">		<span class="comment">// 因为请求是服务端转发到谷歌，所以翻墙这一步也就免了</span></span><br><span class="line">		req.pipe(requestInstance(<span class="string">`https://www.google.com/<span class="subst">$&#123;url.path&#125;</span>`</span>, req.headers[<span class="string">'user-agent'</span>])).pipe(res);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line">Server.listen(port, () =&gt; &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Server on port <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>几行代码，完整可用的免翻墙 Google 搜索就完成了。</p>
<p>按这个思路来，任何网站都可以用这样的思路来玩耍，比如 <code>po**hub.com</code> ??</p>
</div></article></div></section><footer><div class="paginator"><a href="/blog/2018/01/03/使用NodeJS借助阿里云dns解析API实现DDNS/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'luoyefe';
var disqus_identifier = '2018/01/16/30行代码的Google镜像站/';
var disqus_title = '30行代码的Google镜像站';
var disqus_url = 'https://luoyefe.com/blog/2018/01/16/30行代码的Google镜像站/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//luoyefe.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="https://luoyefe.com/blog">Luoye</a>, unless otherwise noted.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78104533-1",'auto');ga('send','pageview');
var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?213cc17b8240ff47d16b1b3aa9dbe0ad";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>